<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>åç‰‡è¨­å®šå¾Œå° | Admin Console</title>
<style>
/* CSS ç¶­æŒåŸæœ¬çš„ç°¡æ½”é¢¨æ ¼ï¼Œå¢åŠ ä¸€é»äº’å‹•å›é¥‹ */
:root { --bg-light:#f8f9fa;--bg-dark:#1e1e1e;--border:#dee2e6;
--primary:#0d6efd;--primary-hover:#0b5ed7;--code-text:#a5d6a7;}
body{display:flex;height:100vh;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
.panel{flex:1;padding:30px;box-sizing:border-box;overflow-y:auto}
.left{background:var(--bg-light);border-right:1px solid var(--border)}
.right{background:var(--bg-dark);color:#fff;display:flex;flex-direction:column;position:relative}
input,textarea{width:100%;padding:10px;border:1px solid #ced4da;border-radius:6px;box-sizing:border-box;font-family:inherit}
input:focus,textarea:focus{outline:2px solid var(--primary);border-color:transparent}
label{font-weight:600;margin-bottom:6px;display:block;color:#495057;font-size:0.9rem}
.form-group{margin-bottom:18px}
.btn{padding:10px 18px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:0.2s}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-hover)}
.btn-primary:disabled{background:#adb5bd;cursor:not-allowed}
.btn-copy{position:absolute;top:20px;right:20px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2)}
.btn-copy:hover{background:rgba(255,255,255,0.2)}
pre{flex:1;white-space:pre-wrap;font-family:Consolas, Monaco, monospace;color:var(--code-text);font-size:14px;line-height:1.5;margin-top:20px}
#status{margin-top:10px;font-size:0.9rem;font-weight:500}
.success{color:#198754} .error{color:#dc3545} .normal{color:#6c757d}
</style>
</head>

<body>

<div class="panel left">
  <h2>ğŸ“¡ è¼‰å…¥è³‡æ–™</h2>
  <div class="form-group">
    <input id="uid" placeholder="User ID (ä¾‹å¦‚: jasper)" autocomplete="off">
    <div style="margin-top:10px">
      <button id="btn-load" class="btn btn-primary" onclick="load()">è®€å– Config</button>
      <span id="status" class="normal">æº–å‚™å°±ç·’</span>
    </div>
  </div>

  <hr style="border:0;border-top:1px solid #e9ecef;margin:25px 0">

  <h2>âœï¸ ç·¨è¼¯å…§å®¹</h2>
  <div class="form-group"><label>å§“å</label><input id="inp-name" oninput="gen()"></div>
  <div class="form-group"><label>è·ç¨±</label><input id="inp-title" oninput="gen()"></div>
  <div class="form-group"><label>ç°¡ä»‹</label><textarea id="inp-bio" rows="4" oninput="gen()"></textarea></div>
  <div class="form-group"><label>é ­åƒ URL</label><input id="inp-avatar" oninput="gen()"></div>

  <h3>ç¤¾ç¾¤é€£çµ</h3>
  <div class="form-group"><label>Instagram</label><input class="link-inp" data-k="instagram" oninput="gen()"></div>
  <div class="form-group"><label>LinkedIn</label><input class="link-inp" data-k="linkedin" oninput="gen()"></div>
  <div class="form-group"><label>GitHub</label><input class="link-inp" data-k="github" oninput="gen()"></div>
  <div class="form-group"><label>Email (è‡ªå‹•åŠ å…¥ mailto:)</label><input class="link-inp" data-k="email" placeholder="user@email.com" oninput="gen()"></div>
  <div class="form-group"><label>Website</label><input class="link-inp" data-k="website" oninput="gen()"></div>
</div>

<div class="panel right">
  <button class="btn btn-copy" onclick="copy()">è¤‡è£½ä»£ç¢¼</button>
  <pre id="out">// è«‹å…ˆè®€å–è³‡æ–™æˆ–æ˜¯è¼¸å…¥å…§å®¹...</pre>
</div>

<script>
// ================= è¨­å®šå€ =================
const GH_USER = "ä½ çš„GitHubå¸³è™Ÿ";
const REPO = "ä½ çš„Repoåç¨±"; // e.g., digital-card
// =========================================

// é è¨­çµæ§‹ï¼Œé˜²æ­¢è®€å–å¤±æ•—æ™‚ç„¡æ³•é‹ä½œ
let originalData = {
  theme: { primaryColor: "#000000" },
  info: {},
  links: {}
};

// 1. è®€å–åŠŸèƒ½
async function load() {
  const uidInput = document.getElementById('uid');
  const btn = document.getElementById('btn-load');
  const id = uidInput.value.trim();

  if (!id) return setStatus("âŒ è«‹è¼¸å…¥ ID", "error");

  // UI é–å®š
  uidInput.disabled = true;
  btn.disabled = true;
  setStatus("â³ è®€å–ä¸­...", "normal");

  // ä¿®æ­£ï¼šé€™è£¡æ‡‰è©²è®€å– JS æª”æ¡ˆè€Œé JSONï¼Œå› ç‚º GitHub ä¸Šå­˜çš„æ˜¯ config.js
  const url = `https://raw.githubusercontent.com/${GH_USER}/${REPO}/main/u/${id}/config.js?t=${Date.now()}`;

  try {
    const res = await fetch(url);
    if (res.status === 404) throw new Error("æ‰¾ä¸åˆ°æ­¤ ID");
    if (!res.ok) throw new Error("ç¶²è·¯é€£ç·šéŒ¯èª¤");

    const text = await res.text();
    
    // åš´è¬¹è§£æï¼šå¾ config.js ä¸­æå– JSON ç‰©ä»¶éƒ¨åˆ†
    // å‡è¨­æ ¼å¼ç‚º const USER_PROFILE = { ... };
    const regex = /const\s+USER_PROFILE\s*=\s*(\{[\s\S]*?});?$/;
    const match = text.match(regex);
    
    if (!match) throw new Error("æª”æ¡ˆæ ¼å¼ä¸ç¬¦ (Parse Error)");

    // å®‰å…¨è½‰æ› String -> Object
    originalData = (new Function("return " + match[1]))();
    
    fillForm(originalData);
    gen(); // ç«‹å³åˆ·æ–°å³å´
    setStatus("âœ… è¼‰å…¥æˆåŠŸ", "success");

  } catch (err) {
    console.error(err);
    setStatus("âŒ " + err.message, "error");
    // å³ä½¿å¤±æ•—ï¼Œä¹Ÿä¿ç•™åŸæœ‰çš„ç”¢ç”ŸåŠŸèƒ½
    gen(); 
  } finally {
    uidInput.disabled = false;
    btn.disabled = false;
  }
}

// 2. å¡«å…¥è¡¨å–®
function fillForm(data) {
  // å®‰å…¨å­˜å–å±¬æ€§ (?.)
  document.getElementById('inp-name').value = data.info?.name || "";
  document.getElementById('inp-title').value = data.info?.title || "";
  document.getElementById('inp-bio').value = data.info?.bio || "";
  document.getElementById('inp-avatar').value = data.info?.avatar || "";

  document.querySelectorAll(".link-inp").forEach(input => {
    const key = input.dataset.k;
    let val = data.links?.[key] || "";
    
    // è™•ç† mailto é‚è¼¯ï¼šé¡¯ç¤ºçµ¦ä½¿ç”¨è€…çœ‹æ™‚ï¼Œæ‹¿æ‰ mailto:
    if (key === "email" && val.startsWith("mailto:")) {
      val = val.replace("mailto:", "");
    }
    input.value = val;
  });
}

// 3. ç”¢ç”Ÿä»£ç¢¼
function gen() {
  // æ”¶é›†åŸºæœ¬è³‡æ–™
  const info = {
    name: document.getElementById('inp-name').value.trim(),
    title: document.getElementById('inp-title').value.trim(),
    bio: document.getElementById('inp-bio').value.trim(),
    avatar: document.getElementById('inp-avatar').value.trim()
  };

  // æ”¶é›†é€£çµè³‡æ–™
  const links = {};
  document.querySelectorAll(".link-inp").forEach(input => {
    const key = input.dataset.k;
    let val = input.value.trim();
    
    // åš´è¬¹çš„ mailto è™•ç†ï¼šå¦‚æœä½¿ç”¨è€…æ²’æ‰“ mailto: ä¸”å€¼ä¸ç‚ºç©ºï¼Œè‡ªå‹•è£œä¸Š
    if (key === "email" && val && !val.startsWith("mailto:")) {
      val = "mailto:" + val;
    }
    links[key] = val;
  });

  // æ·±åº¦åˆä½µ (Deep Merge) ä»¥ä¿ç•™ theme ç­‰éš±è—è¨­å®š
  const finalObj = {
    ...originalData,
    info: { ...originalData.info, ...info },
    links: { ...links } // links é€šå¸¸æ˜¯å®Œå…¨è¦†è“‹
  };

  // ä¿®æ­£ï¼šè¼¸å‡ºç‚º JS è®Šæ•¸å®£å‘Šï¼Œè€Œéç´” JSON
  const output = `const USER_PROFILE = ${JSON.stringify(finalObj, null, 2)};`;
  
  document.getElementById('out').textContent = output;
}

// 4. è¤‡è£½åŠŸèƒ½
function copy() {
  const text = document.getElementById('out').textContent;
  if (text.startsWith("//")) return;
  
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.btn-copy');
    const originalText = btn.textContent;
    btn.textContent = "å·²è¤‡è£½ï¼";
    btn.style.background = "#198754";
    setTimeout(() => {
      btn.textContent = originalText;
      btn.style.background = "";
    }, 2000);
  });
}

// å·¥å…·ï¼šè¨­å®šç‹€æ…‹æ–‡å­—
function setStatus(msg, type) {
  const el = document.getElementById('status');
  el.textContent = msg;
  el.className = type;
}
</script>

</body>
</html>
